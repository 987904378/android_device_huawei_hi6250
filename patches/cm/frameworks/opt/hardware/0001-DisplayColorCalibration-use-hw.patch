From ae2523087b4af39f2b72c3d402360ae01ec0f271 Mon Sep 17 00:00:00 2001
From: Meticulus <theonejohnnyd@gmail.com>
Date: Sat, 11 Feb 2017 17:42:48 -0600
Subject: [PATCH] DisplayColorCalibration: use hw.

Change-Id: I5dd11dd1d9ec958e547db3ad306fa090f1b5ff86
---
 .../hardware/DisplayColorCalibration.java          | 23 +++++++++++++++++++---
 1 file changed, 20 insertions(+), 3 deletions(-)

diff --git a/src/org/cyanogenmod/hardware/DisplayColorCalibration.java b/src/org/cyanogenmod/hardware/DisplayColorCalibration.java
index ac0c6c6..53900ce 100644
--- a/src/org/cyanogenmod/hardware/DisplayColorCalibration.java
+++ b/src/org/cyanogenmod/hardware/DisplayColorCalibration.java
@@ -29,7 +29,7 @@ public class DisplayColorCalibration {
 
     private static final String TAG = "DisplayColorCalibration";
 
-    private static final String COLOR_FILE = "/sys/class/graphics/fb0/rgb";
+    private static final String COLOR_FILE = "/sys/devices/virtual/graphics/fb0/lcd_color_temperature";
 
     private static final boolean sUseGPUMode;
 
@@ -62,18 +62,35 @@ public class DisplayColorCalibration {
         return getMaxValue();
     }
 
+    private static String convertToReturnString(String colors) {
+	Slog.d(TAG, "Meticulus: return in " + colors);
+	String[] splitColors = colors.trim().split(",");
+        colors = String.format("%s %s %s", 
+		splitColors[0],splitColors[4],splitColors[8]);
+	Slog.d(TAG, "Meticulus: return out " + colors);
+	return colors;
+    }
+    
     public static String getCurColors()  {
         if (!sUseGPUMode) {
-            return FileUtils.readOneLine(COLOR_FILE);
+            return convertToReturnString(FileUtils.readOneLine(COLOR_FILE));
         }
 
         return String.format("%d %d %d", sCurColors[0],
                 sCurColors[1], sCurColors[2]);
     }
 
+    private static String convertToDeviceString(String colors) {
+	Slog.d(TAG, "Meticulus: to in " + colors);
+	String[] splitColors = colors.split(" ");
+        colors = String.format("%s,0,0,0,%s,0,0,0,%s", 
+		splitColors[0],splitColors[1],splitColors[2]);
+	Slog.d(TAG, "Meticulus: to out " + colors);
+	return colors;
+    }
     public static boolean setColors(String colors) {
         if (!sUseGPUMode) {
-            return FileUtils.writeLine(COLOR_FILE, colors);
+            return FileUtils.writeLine(COLOR_FILE, convertToDeviceString(colors));
         }
 
         float[] mat = toColorMatrix(colors);
-- 
1.9.1

